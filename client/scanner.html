<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Dashboard | CampusEvents</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }

        .scanner-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
        }

        #reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: none !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .status-card {
            display: none;
            margin-top: 20px;
            border-radius: 16px;
            border: none;
            transition: all 0.3s ease;
        }

        .status-card.active {
            display: block;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .scan-history {
            margin-top: 30px;
        }

        .history-item {
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .badge-success {
            background-color: #dcfce7;
            color: #166534;
        }

        .badge-danger {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .reader-header {
            background: #1e293b;
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #reader__dashboard_section_csr {
            padding: 10px !important;
        }

        button {
            border-radius: 8px !important;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-qr-code-scan me-2"></i> Attendance Scanner</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="adminName">Admin</span>
                <a href="admin.html" class="btn btn-sm btn-outline-light">Back to Admin</a>
            </div>
        </div>
    </nav>

    <div class="container scanner-container">
        <div class="mb-4">
            <label class="form-label fw-bold">Select Event</label>
            <select class="form-select shadow-sm" id="eventSelect">
                <option value="">-- All Events --</option>
            </select>
        </div>

        <div class="card shadow-sm border-0 mb-4 overflow-hidden" style="border-radius: 12px;">
            <div class="reader-header">
                <span class="fw-semibold">Camera Scanner</span>
                <span class="badge bg-success" id="scannerStatus">Ready</span>
            </div>
            <div id="reader"></div>
        </div>

        <div id="statusCard" class="card status-card shadow-sm">
            <div class="card-body p-4 text-center">
                <div id="statusIcon" class="mb-3"></div>
                <h4 id="statusTitle" class="mb-2"></h4>
                <p id="statusMsg" class="mb-3"></p>
                <div id="studentInfo" class="bg-light p-3 rounded-3 text-start d-none">
                    <p class="mb-1 small text-muted">Student Details:</p>
                    <div id="studentDetails"></div>
                </div>
            </div>
        </div>

        <div class="scan-history">
            <h5 class="mb-3">Recent Scans</h5>
            <div id="historyList">
                <p class="text-muted small text-center py-4 bg-white rounded-3">No scans recorded yet.</p>
            </div>
        </div>
    </div>

    <audio id="beepSuccess" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="beepError" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        const API = window.location.origin + '/api';
        let html5QrCode;
        let isScanning = false;
        let lastScannedToken = null;
        let lastScanTime = 0;

        // Auth check
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'admin') {
            window.location.href = 'index.html';
        }
        document.getElementById('adminName').innerText = user.name;

        async function loadEvents() {
            try {
                const res = await fetch(`${API}/events`);
                const events = await res.json();
                const select = document.getElementById('eventSelect');
                events.forEach(ev => {
                    const opt = document.createElement('option');
                    opt.value = ev._id;
                    opt.textContent = ev.title;
                    select.appendChild(opt);
                });
            } catch (err) { console.error(err); }
        }

        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
            isScanning = true;
        }

        async function onScanSuccess(decodedText) {
            const now = Date.now();
            // Prevent multiple rapid scans of same token
            if (decodedText === lastScannedToken && now - lastScanTime < 5000) return;

            lastScannedToken = decodedText;
            lastScanTime = now;

            // QR usually contains: http://host/gate/TOKEN
            let token = decodedText;
            if (decodedText.includes('/gate/')) {
                token = decodedText.split('/gate/')[1];
            }

            // Authentication headers
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${user.token}`
            };

            updateStatus('scanning', 'Verifying token...', 'info');

            try {
                const res = await fetch(`${API}/registrations/scan`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ token })
                });

                const data = await res.json();
                if (res.ok) {
                    showScanResult('success', data);
                    addToHistory('success', data);
                    document.getElementById('beepSuccess').play();
                } else {
                    showScanResult('error', data);
                    addToHistory('error', data);
                    document.getElementById('beepError').play();
                }
            } catch (err) {
                showScanResult('error', { message: 'Network error or invalid server response.' });
                document.getElementById('beepError').play();
            }
        }

        function showScanResult(type, data) {
            const card = document.getElementById('statusCard');
            const icon = document.getElementById('statusIcon');
            const title = document.getElementById('statusTitle');
            const msg = document.getElementById('statusMsg');
            const info = document.getElementById('studentInfo');
            const details = document.getElementById('studentDetails');

            card.className = `card status-card shadow-sm active border-start border-5 ${type === 'success' ? 'border-success' : 'border-danger'}`;

            if (type === 'success') {
                icon.innerHTML = '<i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>';
                title.innerText = 'Attendance Marked';
                title.className = 'text-success mb-2';
                msg.innerText = data.message;

                info.classList.remove('d-none');
                details.innerHTML = `
                    <strong>${data.registration.user.name}</strong><br>
                    <span class="small text-muted">${data.registration.user.registrationNumber || ''} | ${data.registration.user.branch || ''} ${data.registration.user.year ? data.registration.user.year + 'yr' : ''}</span><br>
                    <span class="badge bg-primary mt-1">${data.registration.event.title}</span>
                `;
            } else {
                icon.innerHTML = '<i class="bi bi-x-circle-fill text-danger" style="font-size: 3rem;"></i>';
                title.innerText = 'Scan Failed';
                title.className = 'text-danger mb-2';
                msg.innerText = data.message;
                info.classList.add('d-none');
            }

            // Pulse effect
            card.style.transform = 'scale(1.02)';
            setTimeout(() => card.style.transform = 'scale(1)', 200);

            // Hide result after 7 seconds
            setTimeout(() => {
                if (lastScannedToken === data.registration?.qrToken || lastScannedToken === data.message) {
                    card.classList.remove('active');
                }
            }, 7000);
        }

        function addToHistory(type, data) {
            const list = document.getElementById('historyList');
            if (list.innerText === 'No scans recorded yet.') list.innerHTML = '';

            const item = document.createElement('div');
            item.className = 'history-item';

            const name = data.registration?.user?.name || 'Invalid User';
            const event = data.registration?.event?.title || 'Unknown Event';
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            item.innerHTML = `
                <div>
                    <div class="fw-bold">${name}</div>
                    <div class="small text-muted">${event}</div>
                </div>
                <div class="text-end">
                    <span class="badge ${type === 'success' ? 'badge-success' : 'badge-danger'} mb-1">${type === 'success' ? 'Marked' : 'Failed'}</span>
                    <div class="text-muted small">${time}</div>
                </div>
            `;
            list.prepend(item);
        }

        function updateStatus(state, message, color) {
            const badge = document.getElementById('scannerStatus');
            badge.innerText = message;
            badge.className = `badge bg-${color}`;
        }

        loadEvents();
        startScanner();
    </script>
</body>

</html>